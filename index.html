<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Los Caza-Anuncios: Misi√≥n Revelaci√≥n</title>
<style>
  :root{
    --bg:#0b0f10; --panel:#11181c; --hi:#00ffd0; --warn:#ff3b3b; --ok:#64ff64;
    --text:#ffffff; --muted:#b6c2c9; --accent:#2dd4ff; --gold:#ffe26d;
    --btn:#1e2930; --btnH:#2b3b44; --info:#3bd1ff; --sell:#ff7a3b; --focus:#ffee00;
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
  body{
    margin:0; background:linear-gradient(180deg,#0b0f10,#0a0d10 60%,#0b0f10);
    color:var(--text); font-family:system-ui, -apple-system, sans-serif;
    user-select:none; overflow-x:hidden;
  }
  
  /* HEADER */
  header{
    position:sticky; top:0; z-index:50;
    background:rgba(10,13,16,0.95); backdrop-filter: blur(8px);
    border-bottom:2px solid #0f1c22;
  }
  .bar{
    max-width:1100px; margin:auto; display:grid; gap:8px; padding:10px 12px;
    grid-template-columns: 1fr auto auto auto; align-items:center;
  }
  h1{font-size:clamp(16px,3vw,24px); margin:0; line-height:1.1;}
  .chip{
    background:#0f1720; border:1px solid #25313a; border-radius:12px; 
    padding:4px 10px; font-weight:700; font-size:14px; text-align:center;
  }

  /* LAYOUT */
  main{max-width:900px; margin:15px auto 80px; padding:0 12px;}
  .screen{display:none; animation:fadeIn 0.4s ease;}
  .screen.active{display:block;}
  @keyframes fadeIn{from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)}}

  /* TUTORIAL */
  .tut-container {
    background: #0f1519; border: 2px solid #23323a; border-radius: 16px; padding: 20px;
    text-align: center; position: relative; overflow: hidden;
  }
  .step-box { display: none; }
  .step-box.active { display: block; animation: slideIn 0.3s ease-out; }
  @keyframes slideIn { from{transform:translateX(50px);opacity:0} to{transform:translateX(0);opacity:1}}
  .tut-instruction { font-size: 18px; color: var(--hi); margin-bottom: 15px; }
  .tut-desc { color: var(--muted); margin-bottom: 20px; line-height: 1.5; }

  /* JUEGO & TARJETAS */
  .play-area{
    position:relative; border:3px dashed #244; border-radius:16px; min-height:340px; padding:15px; 
    background:radial-gradient(circle at center, #131b20 0%, #0b0f12 100%);
    display:grid; place-items:center; align-content:center;
  }
  .video-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:15px; width:100%; align-items:start;}
  .feed { display:grid; gap:15px; width:100%; max-width:500px; }

  .card{
    border:3px solid #23323a; border-radius:16px; background:#0d1419; padding:12px; 
    position:relative; overflow:hidden; transition:transform 0.2s, border-color 0.2s; min-height:140px;
    text-align:left; cursor:pointer;
  }
  /* Estilo cuando seleccionas una tarjeta con clic */
  .card.selected {
    border-color: #fff;
    box-shadow: 0 0 0 4px rgba(255,255,255,0.1);
    transform: scale(1.02);
    z-index: 5; /* Asegurar que quede encima al seleccionar */
  }
  
  .card h3{margin:0 0 5px; font-size:18px; color:#fff;}
  .card p{margin:0; color:var(--muted); font-size:14px; line-height:1.4;}
  
  /* HALO (REVELADOR) */
  .halo{
    position:absolute; inset:-3px; border-radius:14px; border:5px solid transparent; 
    pointer-events:none; opacity:0; transition:opacity 0.2s; z-index:2;
  }
  .halo.info{opacity:1; border-color:var(--info); box-shadow:0 0 20px var(--info) inset;}
  .halo.sell{opacity:1; border-color:var(--sell); box-shadow:0 0 20px var(--sell) inset;}
  
  .stamp{
    position:absolute; bottom:10px; right:10px; padding:6px 10px; border-radius:8px; 
    font-weight:900; border:2px solid #fff; background:#000; color:#fff; 
    transform:rotate(-10deg) scale(0); transition:transform 0.3s; z-index:3;
  }
  .stamp.on{transform:rotate(-10deg) scale(1);}
  .stamp.ok{border-color:var(--ok); color:var(--ok); background:#061a0f;}
  .stamp.warn{border-color:var(--warn); color:var(--warn); background:#260a0a;}

  .explain{
    position:absolute; inset:0; background:rgba(0,0,0,0.95); border:2px solid var(--warn); 
    padding:15px; z-index:4; display:none; flex-direction:column; justify-content:center;
  }
  .explain.on{display:flex; animation:blink 0.5s 2;}

  /* BOTONES */
  .hud-actions{ margin-top:15px; display:grid; gap:10px; grid-template-columns: 1fr 1fr; }
  .full-row { grid-column: 1 / -1; display:flex; gap:10px; justify-content:center;}
  
  .btn{
    font-size:clamp(16px,2.5vw,20px); padding:14px; border-radius:12px; border:2px solid #2a3b43; 
    background:var(--btn); color:var(--text); cursor:pointer; font-weight:800; 
    transition:all .1s; display:flex; align-items:center; justify-content:center; gap:8px;
    box-shadow: 0 4px 0 #111;
  }
  .btn:active{transform:translateY(3px); box-shadow: 0 1px 0 #111;}
  .btn:disabled{opacity:0.4; filter:grayscale(1); cursor:not-allowed;}
  
  .btn.primary{border-color:#0ae; background:#0b2733;}
  .btn.ok{border-color:var(--ok); background:#0d3326; color:#dfffe0;}
  .btn.warn{border-color:var(--sell); background:#331414; color:#ffe0d0;}
  
  .btn.active-tool {
    border-color: var(--focus); background: #333300; color: var(--focus);
    box-shadow: 0 0 15px var(--focus);
  }

  .pulse { animation: pulseAnim 1.5s infinite; }
  @keyframes pulseAnim { 0% {box-shadow:0 0 0 0 rgba(0,255,208,0.7)} 70% {box-shadow:0 0 0 12px rgba(0,255,208,0)} 100% {box-shadow:0 0 0 0 rgba(0,255,208,0)} }

  /* LENS (MEJORADO: LIMPIO Y CLARO) */
  .lens{
    position:fixed; width:120px; height:120px; border-radius:50%; 
    border:4px solid var(--focus); 
    /* Fondo casi transparente, solo un tinte muy sutil */
    background: rgba(255, 255, 0, 0.05);
    pointer-events:none; z-index:100; display:none;
    /* Glow solo en el borde, sin opacar el centro */
    box-shadow: 0 0 15px var(--focus), inset 0 0 10px rgba(255,255,0,0.2);
  }
  .lens.on{display:block;}
  .lens::after{ content:'BUSCANDO...'; position:absolute; bottom:-25px; left:50%; transform:translateX(-50%); background:var(--focus); color:#000; font-size:10px; padding:2px 4px; border-radius:4px; font-weight:bold;}

  /* POPUP */
  .popup-ad {
    position:absolute; background:#201010; border:4px solid var(--warn); padding:20px; border-radius:16px;
    box-shadow:0 20px 50px #000; text-align:center; z-index:10; max-width:320px;
    display:none; animation:popIn 0.3s; cursor: pointer;
  }
  .popup-ad.active { display:block; }
  /* Estilo seleccionado para el popup */
  .popup-ad.selected { border-color: #fff; transform: scale(1.02); z-index: 15; box-shadow: 0 0 20px rgba(255,255,255,0.2); }
  
  @keyframes popIn { from{transform:scale(0.5); opacity:0;} to{transform:scale(1); opacity:1;} }
  
  /* OVERLAY */
  .overlay{ position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:200; display:none; place-items:center; padding:20px; text-align:center;}
  .overlay.active{ display:grid; }
  .modal{ background:#161f26; padding:25px; border-radius:16px; border:2px solid var(--warn); max-width:400px; }

</style>
</head>
<body>

<header>
  <div class="bar">
    <h1>üïµÔ∏è‚Äç‚ôÇÔ∏è Caza-Anuncios</h1>
    <div class="chip" id="stateChip">TUTORIAL</div>
    <div class="chip" id="livesChip">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
    <div class="chip" id="scoreChip">0</div>
  </div>
</header>

<main>
  <!-- PANTALLA 1: BRIEFING / TUTORIAL INTERACTIVO -->
  <section id="screenBriefing" class="screen active">
    <div class="tut-container">
      
      <!-- Paso 1 -->
      <div id="step1" class="step-box active">
        <div style="font-size:40px; margin-bottom:10px;">üëã</div>
        <h2 class="tut-instruction">Bienvenido</h2>
        <p class="tut-desc">Internet tiene dos caras: <b>Informaci√≥n √ötil</b> y <b>Publicidad Oculta</b>.<br>Tu misi√≥n es identificar cu√°l es cu√°l.</p>
        <button class="btn primary big" onclick="nextStep(2)">Continuar</button>
      </div>

      <!-- Paso 2: Herramientas -->
      <div id="step2" class="step-box">
        <div style="font-size:40px; margin-bottom:10px;">üõ†Ô∏è</div>
        <h2 class="tut-instruction">Herramientas</h2>
        <p class="tut-desc">Tienes un <b>Revelador</b>. Haz clic en el bot√≥n de abajo para encenderlo o apagarlo. Pru√©balo ahora:</p>
        <button id="btnTutScanner" class="btn primary pulse">üî¶ ENCENDER REVELADOR</button>
      </div>

      <!-- Paso 3: Selecci√≥n -->
      <div id="step3" class="step-box">
        <h2 class="tut-instruction">Identificar y Seleccionar</h2>
        <p class="tut-desc">1. Pasa el revelador. Ver√°s un <b>Halo Naranja</b>.<br>2. <b>HAZ CLIC en la tarjeta</b> para seleccionarla.</p>
        
        <div style="display:flex; justify-content:center; margin:20px 0;">
          <div class="card" id="tutTarget" data-intent="sell" style="width:250px;">
            <h3>¬°GANASTE UN IPHONE!</h3>
            <p>Haz clic aqu√≠ ya para reclamarlo.</p>
            <div class="halo"></div>
            <div class="stamp"></div>
          </div>
        </div>
        <p id="tutStatus" style="font-size:14px; color:var(--muted)">Esperando selecci√≥n...</p>
      </div>

      <!-- Paso 4: Clasificaci√≥n -->
      <div id="step4" class="step-box">
        <h2 class="tut-instruction">Clasificar</h2>
        <p class="tut-desc">La tarjeta est√° seleccionada (borde blanco).<br>Como vimos el halo naranja, presiona el bot√≥n correcto:</p>
        <div class="hud-actions">
          <button id="btnTutInfo" class="btn ok">üìö Informar</button>
          <button id="btnTutSell" class="btn warn pulse">üí∞ Publicidad</button>
        </div>
      </div>

      <!-- Paso 5: Fin -->
      <div id="step5" class="step-box">
        <div style="font-size:40px; margin-bottom:10px;">‚úÖ</div>
        <h2 class="tut-instruction">¬°Listo!</h2>
        <p class="tut-desc">Recuerda: <b>Halo Naranja</b> = Publicidad/Enga√±o. <b>Halo Azul</b> = Informativo.<br>¬°Cuidado con las ofertas falsas!</p>
        <button class="btn primary big" onclick="startGame()">üöÄ INICIAR MISI√ìN</button>
      </div>

    </div>
  </section>

  <!-- PANTALLA 2: JUEGO -->
  <section id="screenGame" class="screen">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px; align-items:center;">
      <h3 id="scenarioTitle" style="margin:0; color:var(--accent)">Escenario 1</h3>
      <span id="progText" style="font-size:14px; color:var(--muted)">0/3</span>
    </div>

    <!-- √Årea de Juego -->
    <div id="playArea" class="play-area"></div>

    <!-- Controles -->
    <div class="hud-actions">
      <button id="btnClassifyInfo" class="btn ok" disabled>üìö Es Informativo</button>
      <button id="btnClassifySell" class="btn warn" disabled>üí∞ Es Publicidad</button>
      
      <div class="full-row">
        <button id="btnScanner" class="btn primary big" style="width:100%">üî¶ REVELADOR (ON/OFF)</button>
      </div>
    </div>
  </section>

  <!-- PANTALLA 3: REPORTE -->
  <section id="screenReport" class="screen">
    <div class="tut-container">
      <h2>üìä Resultado Final</h2>
      <h1 id="finalScore" style="font-size:48px; margin:10px 0; color:var(--gold)">0</h1>
      <p id="finalMsg">...</p>
      
      <div style="margin-top:20px; text-align:left; background:#111; padding:15px; border-radius:8px;">
        <small>Espectros encontrados:</small>
        <div id="pediaList" style="margin-top:5px;"></div>
      </div>

      <div class="hud-actions">
        <button class="btn primary" onclick="startCampaign()">üîÅ Reintentar</button>
        <button class="btn warn" onclick="startTimeAttack()">‚è±Ô∏è Contrarreloj</button>
      </div>
    </div>
  </section>

</main>

<!-- LENTE -->
<div id="lens" class="lens"></div>

<!-- OVERLAY PAUSA -->
<div id="overlay" class="overlay">
  <div class="modal">
    <h2 id="modalTitle" style="color:var(--warn)">¬°ALTO!</h2>
    <p id="modalText">Texto...</p>
    <button class="btn primary" onclick="closeModal()">Continuar</button>
  </div>
</div>

<script>
/* LOGICA DEL JUEGO */

// Audio Simple
const Sfx = {
  ctx: new (window.AudioContext || window.webkitAudioContext)(),
  play(type) {
    if (this.ctx.state === 'suspended') this.ctx.resume();
    const osc = this.ctx.createOscillator();
    const gain = this.ctx.createGain();
    osc.connect(gain); gain.connect(this.ctx.destination);
    const now = this.ctx.currentTime;
    
    if (type === 'toggle') { 
      osc.frequency.setValueAtTime(400, now); osc.frequency.linearRampToValueAtTime(600, now + 0.1);
      gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.1);
      osc.start(now); osc.stop(now + 0.1);
    } else if (type === 'ok') {
      osc.type = 'triangle'; osc.frequency.setValueAtTime(400, now); osc.frequency.linearRampToValueAtTime(800, now + 0.1);
      gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.2);
      osc.start(now); osc.stop(now + 0.2);
    } else if (type === 'bad') {
      osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(100, now + 0.3);
      gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now + 0.3);
      osc.start(now); osc.stop(now + 0.3);
    }
  }
};

const Game = {
  mode: 'tutorial', 
  scanning: false,
  lives: 3, score: 0, level: 0,
  completedInLevel: 0, targetInLevel: 0,
  currentTarget: null, // Card seleccionada
  pedia: new Set()
};

const Scenarios = [
  {
    title: "1. Videos",
    items: [
      { id:'v1', type:'video', title:'Volc√°n Casero', desc:'Tutorial paso a paso.', intent:'info', tricks:[] },
      { id:'v2', type:'video', title:'¬°JUGUETE NUEVO!', desc:'¬°C√≥mpralo YA!', intent:'sell', tricks:['Urgencia', 'Gritos'] },
      { id:'v3', type:'video', title:'Gameplay', desc:'Jugando Minecraft.', intent:'info', tricks:[] }
    ]
  },
  {
    title: "2. Juego Gratis",
    items: [
      { id:'popup1', type:'popup', title:'‚ö° OFERTA FLASH', desc:'Auto Dorado. Solo 100 gemas.', intent:'sell', tricks:['Temporizador', 'Bot√≥n Trampa'] }
    ]
  },
  {
    title: "3. Red Social",
    items: [
      { id:'p1', type:'post', title:'Foto de mi perro', desc:'Paseando.', intent:'info', tricks:[] },
      { id:'p3', type:'post-ad', title:'GALLETAS', desc:'¬°Las mejores! #Patrocinado', intent:'sell', tricks:['Etiqueta Patrocinado'] }
    ]
  }
];

// --- TUTORIAL ---
function nextStep(n) {
  document.querySelectorAll('.step-box').forEach(el => el.classList.remove('active'));
  document.getElementById('step' + n).classList.add('active');
  
  if(n === 2) {
    const btn = document.getElementById('btnTutScanner');
    btn.onclick = () => {
      toggleScanner(true);
      btn.classList.remove('pulse'); btn.innerText = "REVELADOR ENCENDIDO";
      setTimeout(() => nextStep(3), 800);
    };
  }
  if(n === 3) {
    const t = document.getElementById('tutTarget');
    t.onclick = () => {
      t.classList.add('selected');
      t.querySelector('.halo').className = 'halo sell'; 
      t.querySelector('.halo').style.opacity = 1;
      document.getElementById('tutStatus').innerText = "‚úÖ Tarjeta Seleccionada";
      document.getElementById('tutStatus').style.color = "var(--ok)";
      setTimeout(() => nextStep(4), 800);
    };
  }
  if(n === 4) {
    document.getElementById('btnTutInfo').onclick = () => { Sfx.play('bad'); alert("Incorrecto. Mira el halo naranja."); };
    document.getElementById('btnTutSell').onclick = () => {
      Sfx.play('ok');
      const s = document.getElementById('tutTarget').querySelector('.stamp');
      s.className = 'stamp on ok'; s.innerText = "¬°ANUNCIO!";
      toggleScanner(false);
      setTimeout(() => nextStep(5), 1000);
    };
  }
}

// --- CORE ---
function startGame() { startCampaign(); }

function startCampaign() {
  Game.mode = 'campaign'; Game.lives = 3; Game.score = 0; Game.pedia.clear();
  toggleScanner(false);
  loadLevel(0);
  switchScreen('screenGame');
}

function switchScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function loadLevel(idx) {
  if(idx >= Scenarios.length) { showReport(); return; }
  Game.level = idx; Game.completedInLevel = 0;
  const sc = Scenarios[idx];
  Game.targetInLevel = sc.items.length;
  
  document.getElementById('scenarioTitle').textContent = sc.title;
  const area = document.getElementById('playArea');
  area.innerHTML = ''; area.className = 'play-area';

  if(idx === 1) { // Popup Level
    area.innerHTML = '<h3 style="opacity:0.5;">üéÆ Jugando...</h3>';
    setTimeout(() => spawnPopup(sc.items[0]), 800);
  } else {
    const grid = document.createElement('div');
    grid.className = idx === 2 ? 'feed' : 'video-grid';
    sc.items.forEach(item => {
      const c = document.createElement('div');
      c.className = 'card';
      c.dataset.id = item.id; c.dataset.intent = item.intent; c.dataset.tricks = JSON.stringify(item.tricks);
      let icon = item.type === 'video' ? 'üé¨' : 'üìÑ';
      c.innerHTML = `<div class="halo"></div><h3>${icon} ${item.title}</h3><p>${item.desc}</p><div class="stamp"></div><div class="explain"></div>`;
      c.addEventListener('click', () => selectCard(c));
      grid.appendChild(c);
    });
    area.appendChild(grid);
  }
  updateUI(); resetControls();
}

function spawnPopup(item) {
  // Limpiar el √°rea antes de a√±adir el popup para evitar duplicados
  const area = document.getElementById('playArea');
  area.innerHTML = '';
  
  const pop = document.createElement('div');
  pop.className = 'popup-ad active';
  pop.dataset.id = item.id; pop.dataset.intent = item.intent; pop.dataset.tricks = JSON.stringify(item.tricks);
  pop.innerHTML = `<div class="halo"></div><h2 style="color:var(--gold)">${item.title}</h2><p>${item.desc}</p><h1 style="color:white; margin:10px 0;">00:59</h1><button class="btn warn" id="trapBtn" style="width:100%">COMPRAR</button><div class="stamp"></div><div class="explain"></div>`;
  
  pop.addEventListener('click', (e) => {
    if(e.target.id !== 'trapBtn') selectCard(pop);
  });
  
  area.appendChild(pop);
  
  document.getElementById('trapBtn').addEventListener('click', (e) => {
    e.stopPropagation(); takeDamage("¬°Ca√≠ste en la trampa! No compres por impulso.");
  });
}

// --- SELECCION Y ESCANER ---
function selectCard(el) {
  if(el.classList.contains('solved')) return;
  document.querySelectorAll('.selected').forEach(x => x.classList.remove('selected'));
  
  Game.currentTarget = el;
  el.classList.add('selected');
  
  // Actualizar halo basado en selecci√≥n
  const halo = el.querySelector('.halo');
  const intent = el.dataset.intent;
  halo.className = `halo ${intent}`; 
  
  if(Game.scanning) halo.style.opacity = 1; 
  else halo.style.opacity = 0; 
  
  // Habilitar botones
  document.getElementById('btnClassifyInfo').disabled = false;
  document.getElementById('btnClassifySell').disabled = false;
}

const scanBtn = document.getElementById('btnScanner');
scanBtn.addEventListener('click', () => toggleScanner(!Game.scanning));

function toggleScanner(state) {
  Game.scanning = state;
  Sfx.play('toggle');
  const lensEl = document.getElementById('lens');
  if(Game.scanning) {
    lensEl.classList.add('on');
    scanBtn.classList.add('active-tool');
    scanBtn.textContent = "üî¶ REVELADOR (ON)";
    if(Game.currentTarget) Game.currentTarget.querySelector('.halo').style.opacity = 1;
  } else {
    lensEl.classList.remove('on');
    scanBtn.classList.remove('active-tool');
    scanBtn.textContent = "üî¶ REVELADOR (OFF)";
    if(Game.currentTarget) Game.currentTarget.querySelector('.halo').style.opacity = 0;
  }
}

// Movimiento del lente
const lensEl = document.getElementById('lens');
function moveLens(x, y) {
  if(!Game.scanning) return;
  lensEl.style.left = (x - 60) + 'px';
  lensEl.style.top = (y - 60) + 'px';
  
  // Reset halos no seleccionados
  document.querySelectorAll('.halo').forEach(h => {
     if(h.parentElement !== Game.currentTarget) h.style.opacity = 0;
  });

  const el = document.elementFromPoint(x, y);
  const card = el ? el.closest('[data-intent]') : null;
  if(card && !card.classList.contains('solved')) {
    const intent = card.dataset.intent;
    const h = card.querySelector('.halo');
    h.className = `halo ${intent}`;
    h.style.opacity = 1;
  }
  
  if(Game.currentTarget) Game.currentTarget.querySelector('.halo').style.opacity = 1;
}
document.addEventListener('mousemove', e => moveLens(e.clientX, e.clientY));
document.addEventListener('touchmove', e => moveLens(e.touches[0].clientX, e.touches[0].clientY), {passive:true});

// --- CLASIFICACION ---
document.getElementById('btnClassifyInfo').addEventListener('click', () => makeDecision('info'));
document.getElementById('btnClassifySell').addEventListener('click', () => makeDecision('sell'));

function makeDecision(choice) {
  if(!Game.currentTarget) return;
  const el = Game.currentTarget;
  const real = el.dataset.intent;
  const stamp = el.querySelector('.stamp');
  
  if(choice === real) {
    Sfx.play('ok');
    stamp.className = 'stamp on ok'; stamp.textContent = choice==='info' ? "SEGURO" : "ANUNCIO";
    Game.score += 100;
    if(real === 'sell') {
      const t = el.querySelector('h2') ? el.querySelector('h2').textContent : el.querySelector('h3').textContent;
      Game.pedia.add(t.replace(/[^a-zA-Z ]/g,"").substring(0,12));
    }
    el.classList.add('solved');
    el.classList.remove('selected');
    
    // IMPORTANTE: Limpiar control y timeout seguro
    resetControls();
    setTimeout(checkProgress, 800);
  } else {
    Sfx.play('bad');
    // NO quitamos la selecci√≥n ni deshabilitamos controles para permitir reintento r√°pido
    stamp.className = 'stamp on warn'; stamp.textContent = "ERROR";
    const tricks = JSON.parse(el.dataset.tricks);
    const expl = el.querySelector('.explain');
    if(expl) {
      expl.classList.add('on');
      expl.innerHTML = `<b>¬°Te enga√±aron!</b><br>Usaron: ${tricks.join(', ')}`;
    }
    takeDamage("Clasificaste mal. Intenta de nuevo.");
  }
}

function checkProgress() {
  Game.completedInLevel++;
  updateUI();
  
  // Verificamos si terminamos el nivel actual
  if(Game.completedInLevel >= Game.targetInLevel) {
    if(Game.mode === 'campaign') {
      // Forzar limpieza completa del DOM antes de cargar el siguiente nivel
      // esto soluciona el "congelamiento" del popup
      document.getElementById('playArea').innerHTML = '';
      setTimeout(() => loadLevel(Game.level + 1), 100);
    } else {
      nextTARound();
    }
  }
}

function takeDamage(msg) {
  Game.lives--; updateUI();
  if(Game.lives <= 0) {
    openModal("¬°Juego Terminado!", "Vuelve a intentar.");
    document.querySelector('#overlay button').onclick = () => location.reload();
  } else {
    openModal("¬°Cuidado!", msg);
  }
}

// --- CONTRARRELOJ ---
function startTimeAttack() {
  Game.mode='timeAttack'; Game.lives=3; Game.score=0; Game.pedia.clear();
  Game.taRound=0; switchScreen('screenGame');
  document.getElementById('scenarioTitle').textContent = "Contrarreloj";
  nextTARound();
}
function nextTARound() {
  Game.taRound++; Game.targetInLevel=1; Game.completedInLevel=0;
  document.getElementById('playArea').innerHTML=''; 
  document.getElementById('progText').textContent = `Ronda ${Game.taRound}`;
  
  const types = ['virus','survey','cheat','video','post'];
  const type = types[Math.floor(Math.random()*types.length)];
  const isTrap = Math.random() > 0.4;
  
  const c = document.createElement('div'); c.className='card';
  c.dataset.intent = isTrap ? 'sell' : 'info';
  c.dataset.tricks = isTrap ? '["Enga√±o"]' : '[]';
  const title = isTrap ? "¬°GANASTE!" : "Noticia";
  c.innerHTML = `<div class="halo"></div><h3>${isTrap?'‚ö†Ô∏è':'‚ÑπÔ∏è'} ${title}</h3><p>Descripci√≥n...</p><div class="stamp"></div>`;
  c.addEventListener('click', ()=>selectCard(c));
  document.getElementById('playArea').appendChild(c);
  resetControls();
}

// UI & Modal
function updateUI() {
  document.getElementById('livesChip').textContent = "‚ù§Ô∏è".repeat(Math.max(0,Game.lives));
  document.getElementById('scoreChip').textContent = Game.score;
  document.getElementById('stateChip').textContent = Game.mode==='campaign' ? `NIVEL ${Game.level+1}` : 'CONTRARRELOJ';
  document.getElementById('progText').textContent = `${Game.completedInLevel}/${Game.targetInLevel}`;
}
function resetControls() {
  Game.currentTarget = null;
  document.getElementById('btnClassifyInfo').disabled = true;
  document.getElementById('btnClassifySell').disabled = true;
  document.querySelectorAll('.selected').forEach(x=>x.classList.remove('selected'));
}
function showReport() {
  switchScreen('screenReport');
  document.getElementById('finalScore').textContent = Game.score;
  document.getElementById('finalMsg').textContent = Game.lives>0?"¬°Bien hecho!":"Intenta de nuevo";
  const l = document.getElementById('pediaList'); l.innerHTML='';
  Game.pedia.forEach(i=>l.innerHTML+=`<span style="background:#333;padding:4px;margin:2px;border-radius:4px;display:inline-block">${i}</span>`);
}
function openModal(t,x) {
  document.getElementById('modalTitle').textContent=t;
  document.getElementById('modalText').innerHTML=x;
  document.getElementById('overlay').classList.add('active');
}
function closeModal(){ document.getElementById('overlay').classList.remove('active'); }

</script>
</body>
</html>
