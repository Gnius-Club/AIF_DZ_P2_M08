<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Los Caza-Anuncios: MisiÃ³n RevelaciÃ³n</title>
<style>
  :root{
    --bg:#0b0f10;
    --panel:#11181c;
    --hi:#00ffd0;
    --warn:#ff3b3b;
    --ok:#64ff64;
    --text:#ffffff;
    --muted:#b6c2c9;
    --accent:#2dd4ff;
    --gold:#ffe26d;
    --btn:#1e2930;
    --btnH:#2b3b44;
    --info:#3bd1ff;
    --sell:#ff7a3b;
    --focus:#ffee00;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:linear-gradient(180deg,#0b0f10,#0a0d10 60%,#0b0f10);
    color:var(--text); font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Color Emoji", "Apple Color Emoji", sans-serif;
  }
  header{
    position:sticky; top:0; z-index:50;
    background:rgba(10,13,16,0.9); backdrop-filter: blur(6px);
    border-bottom:2px solid #0f1c22;
  }
  .bar{
    max-width:1100px; margin:auto; display:grid; gap:8px; padding:10px 12px;
    grid-template-columns: 1fr auto auto auto auto;
    align-items:center;
  }
  h1{font-size:clamp(18px,3.3vw,28px); margin:0; line-height:1.1}
  .hud{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end}
  .chip{
    background:#0f1720; border:2px solid #25313a; border-radius:14px; padding:6px 10px; font-weight:700; min-width:90px; text-align:center;
  }
  .lives span{font-size:20px}
  .toggle{
    display:flex; gap:8px; align-items:center; user-select:none; cursor:pointer;
  }
  .toggle input{transform:scale(1.4)}
  main{max-width:1100px; margin:10px auto 80px; padding:10px 12px;}
  .screen{display:none; border:2px solid #0f1c22; border-radius:16px; background:var(--panel); padding:14px;}
  .screen.active{display:block;}
  .grid-brief{display:grid; gap:12px}
  .brief-panel{
    border:2px solid #23323a; border-radius:16px; padding:16px; background:#0f1519;
  }
  .brief-split{display:grid; gap:10px; grid-template-columns:1fr 1fr}
  .card{
    border:3px solid #23323a; border-radius:16px; background:#0d1419; padding:12px; min-height:120px; position:relative; overflow:hidden;
  }
  .card h3{margin:0 0 4px; font-size:20px}
  .card p{margin:6px 0; color:var(--muted)}
  .btn{
    font-size:clamp(18px,3.2vw,22px); padding:14px 18px; border-radius:16px; border:3px solid #2a3b43; background:var(--btn); color:var(--text); cursor:pointer; font-weight:900; letter-spacing:.3px;
    box-shadow:0 4px 0 #0a1216; transition:.1s transform;
    touch-action:manipulation;
  }
  .btn:disabled{opacity:.5; cursor:not-allowed; filter:grayscale(30%)}
  .btn:hover{background:var(--btnH)}
  .btn:active{transform:translateY(2px)}
  .btn.big{font-size:clamp(20px,4.2vw,28px); padding:16px 22px}
  .btn.primary{border-color:#0ae; background:#0b2733}
  .btn.ok{border-color:#1d7; background:#0d3326}
  .btn.warn{border-color:#f55; background:#331414}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .center{display:flex; gap:12px; justify-content:center; align-items:center; flex-wrap:wrap}
  .right{display:flex; justify-content:flex-end}
  .spacer{height:10px}
  /* City / Scenarios */
  .city{display:grid; grid-template-columns:1fr; gap:12px}
  .play-area{
    position:relative; border:3px dashed #244; border-radius:16px; min-height:320px; padding:10px; overflow:hidden;
    background:radial-gradient(200px 200px at 20% 0%, #0d1b22 0%, #0c1216 60%, #0b0f12 100%);
  }
  .targets{display:grid; gap:10px}
  .video-grid{display:grid; grid-template-columns:repeat(3, 1fr); gap:10px}
  .video-card{cursor:pointer; user-select:none}
  .tag{position:absolute; top:8px; right:8px; background:#102028; padding:3px 8px; border:2px solid #2a3b43; border-radius:999px; font-size:14px}
  .logo-box{position:absolute; bottom:10px; right:10px; background:#111; color:#fff; border:3px solid #444; border-radius:8px; padding:4px 6px; font-weight:800; font-size:14px}
  .color-burst{position:absolute; inset:0; background:conic-gradient(from 90deg, #ff6a00, #ffd500, #ff00aa, #00ffd0, #ff6a00); mix-blend-mode:screen; opacity:.25; pointer-events:none}
  .halo{
    position:absolute; inset:-3px; border-radius:14px; border:5px solid transparent; pointer-events:none; display:none;
  }
  .halo.info{display:block; border-color:var(--info); box-shadow:0 0 24px var(--info) inset, 0 0 18px var(--info)}
  .halo.sell{display:block; border-color:var(--sell); box-shadow:0 0 24px var(--sell) inset, 0 0 18px var(--sell)}
  .stamp{
    position:absolute; inset:auto 8px 8px auto; padding:6px 10px; border-radius:10px; font-weight:900; border:3px solid #234; background:#0b1a22; display:none;
  }
  .stamp.on{display:block}
  .stamp.ok{border-color:#194; background:#0a2618}
  .stamp.warn{border-color:#944; background:#26110f}
  .explain{
    position:absolute; inset:6px; background:rgba(0,0,0,.7); border:3px dashed var(--warn); border-radius:14px; padding:10px; display:none;
  }
  .explain.on{display:block; animation:blink 600ms steps(2,end) 3}
  .explain b{color:var(--gold)}
  @keyframes blink{50%{opacity:.4}}
  /* Pop-up in Scenario 2 */
  .popup{
    position:absolute; inset:10% 8% auto 8%; background:#1a0f12; border:4px solid var(--warn); border-radius:16px; padding:16px; z-index:5; box-shadow:0 10px 40px rgba(0,0,0,.6);
    display:none;
  }
  .popup.on{display:block}
  .timer{font-weight:900; font-size:22px; color:var(--gold)}
  .buy-btn{font-size:22px; padding:10px 14px; border-radius:14px; background:#331214; border:3px solid #ff5a5a; color:#fff; cursor:pointer}
  /* Social feed */
  .feed{display:grid; gap:10px}
  .post{min-height:120px}
  .img-cookie{
    background:radial-gradient(circle at 30% 30%, #f7d9a3, #cc9a52);
    border:4px solid #503418; color:#111;
  }
  .spon-tag{
    position:absolute; top:8px; left:8px; background:#352; border:3px solid #6b6; color:#cfc; padding:4px 8px; border-radius:10px; font-weight:900; display:none;
  }
  /* HUD footer */
  .hud-actions{
    margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; align-items:center
  }
  .classify{
    display:flex; gap:10px; flex-wrap:wrap;
  }
  .glossary{
    border:2px solid #24343d; border-radius:14px; padding:10px; background:#0d151a; font-size:16px
  }
  .glossary ul{margin:8px 0 0 18px}
  .glossary b{color:var(--accent)}
  /* Scanner lens */
  .lens{
    position:fixed; width:110px; height:110px; border-radius:999px; border:4px solid var(--focus); pointer-events:none; mix-blend-mode:screen; z-index:60;
    display:none; box-shadow:0 0 24px var(--focus), inset 0 0 30px rgba(255,255,0,.2);
  }
  .lens.scanning{display:block; animation:pulse 900ms infinite}
  .lens::after{
    content:'ğŸ” Revelador'; position:absolute; bottom:-30px; left:50%; transform:translateX(-50%); font-weight:900; font-size:14px; text-shadow:1px 1px 2px #000;
  }
  @keyframes pulse{50%{box-shadow:0 0 38px var(--focus), inset 0 0 30px rgba(255,255,0,.35)}}
  /* Report */
  .report{
    display:grid; gap:12px;
  }
  .badge{display:inline-block; padding:6px 10px; border-radius:12px; border:3px solid #2a3b43; background:#0e1a20; margin-right:6px; font-weight:900}
  .pedia{display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:8px}
  .pedia .card{min-height:80px}
  /* Pause overlay */
  .overlay{
    position:fixed; inset:0; background:rgba(0,0,0,.75); display:none; align-items:center; justify-content:center; z-index:99;
  }
  .overlay.on{display:flex}
  .modal{
    width:min(720px,92vw); background:#0e1519; border:4px solid #244; border-radius:16px; padding:18px; text-align:center
  }
  .sr-only{
    position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0;
  }
  /* Responsive */
  @media (max-width:860px){
    .brief-split{grid-template-columns:1fr}
    .video-grid{grid-template-columns:1fr; }
  }
</style>
</head>
<body>
<header>
  <div class="bar" role="banner">
    <h1>ğŸ•µï¸â€â™‚ï¸ Los Caza-Anuncios: <span style="color:var(--accent)">MisiÃ³n RevelaciÃ³n</span></h1>
    <div id="stateChip" class="chip">BRIEFING</div>
    <div id="scoreChip" class="chip">Puntaje: 0</div>
    <div id="progChip" class="chip">Progreso: 0/0</div>
    <div class="chip lives" id="livesChip" aria-live="polite">Vidas: <span>â¤ï¸â¤ï¸â¤ï¸</span></div>
    <label class="toggle"><input id="voiceToggle" type="checkbox" /> Voz</label>
  </div>
</header>

<main>
  <!-- BRIEFING -->
  <section id="briefingScreen" class="screen active" aria-labelledby="btitle">
    <h2 id="btitle">ğŸš€ Briefing: Â¡PrepÃ¡rate, Caza-Anuncios!</h2>
    <div class="grid-brief">
      <div class="brief-panel">
        <h3>Panel 1 â€” Informativo vs. Publicitario</h3>
        <div class="brief-split">
          <div class="card">
            <h3>ğŸ“š Documental de Leones</h3>
            <p>Describe cÃ³mo viven y cazan. <b>IntenciÃ³n:</b> informar.</p>
          </div>
          <div class="card">
            <div class="color-burst"></div>
            <h3>ğŸ’° Cereal con Mascota</h3>
            <p>Colores fuertes, mascota gritando <b>â€œÂ¡CÃ“MPRALO YA!â€</b> â€” IntenciÃ³n: vender/persuadir.</p>
          </div>
        </div>
      </div>
      <div class="brief-panel">
        <h3>Panel 2 â€” TÃ©cnicas Publicitarias</h3>
        <ul>
          <li>Colores brillantes y llamativos ğŸ¨</li>
          <li>MÃºsica/ritmo pegajoso ğŸµ</li>
          <li>Urgencia: <b>â€œÂ¡OFERTA LIMITADA!â€</b>, <b>â€œÂ¡COMPRA YA!â€</b> â±ï¸</li>
          <li>Etiqueta <b>â€œpatrocinadoâ€</b> o <b>cÃ³digo de descuento</b></li>
        </ul>
      </div>
      <div class="brief-panel">
        <h3>Panel 3 â€” Tu Herramienta</h3>
        <p>El <b>Revelador de Intenciones</b> te deja â€œapuntar y revelarâ€ lo que hay detrÃ¡s. MantÃ©n pulsado (clic/tap) o presiona <kbd>Espacio</kbd> para escanear. Luego clasifica con ğŸ“š o ğŸ’° (<kbd>1</kbd>/<kbd>2</kbd>).</p>
        <div class="center">
          <button class="btn big primary" id="startBtn">ğŸ¯ Recibir Revelador y entrar a la Ciudad</button>
        </div>
      </div>
    </div>
  </section>

  <!-- CITY / SCENARIOS -->
  <section id="cityScreen" class="screen" aria-labelledby="ctitle">
    <h2 id="ctitle">ğŸ™ï¸ Ciudad â€” Escenarios</h2>

    <!-- Scenario container -->
    <div id="scenarioContainer" class="city">
      <!-- Play area dynamically filled -->
      <div id="playArea" class="play-area" aria-live="polite"></div>

      <!-- HUD actions -->
      <div class="hud-actions">
        <div class="classify" aria-label="Clasificar">
          <button id="btnInfo" class="btn big ok" disabled>ğŸ“š Clasificar</button>
          <button id="btnSell" class="btn big warn" disabled>ğŸ’° Clasificar</button>
        </div>
        <div class="row">
          <button id="btnReveal" class="btn big">ğŸ”¦ Activar Revelador</button>
          <button id="btnRetry" class="btn big">ğŸ” Reintentar</button>
        </div>
      </div>

      <div class="glossary" aria-label="Glosario">
        <b>Glosario â€” SeÃ±ales de anuncio</b>
        <ul>
          <li>ğŸ¨ Colores muy vivos</li>
          <li>â±ï¸ Urgencia: â€œOFERTAâ€, â€œCOMPRA YAâ€, temporizador</li>
          <li>ğŸ·ï¸ â€œpatrocinadoâ€</li>
          <li>ğŸ·ï¸ CÃ³digo de descuento</li>
        </ul>
        <small>Frase de poder: <i>â€œÂ¡Con colores y prisa me quieren llevar, pero yo decido en quÃ© confiar!â€</i></small>
      </div>
    </div>
  </section>

  <!-- REPORT -->
  <section id="reportScreen" class="screen" aria-labelledby="rtitle">
    <h2 id="rtitle">ğŸ“Š Reporte de la MisiÃ³n</h2>
    <div class="report">
      <div id="reportSummary" class="card"></div>
      <div class="card">
        <h3>ğŸ’ Espectro-pedia</h3>
        <div id="pedia" class="pedia"></div>
      </div>
      <div class="center">
        <button id="btnTimeAttack" class="btn big primary">â±ï¸ Modo Contrarreloj (20 en 60 s)</button>
        <button id="btnReset" class="btn big">ğŸ”„ Reiniciar CampaÃ±a</button>
      </div>
    </div>
  </section>
</main>

<!-- Overlay Pause -->
<div id="pauseOverlay" class="overlay" role="dialog" aria-modal="true">
  <div class="modal">
    <h3>ğŸ›‘ Pausa de aprendizaje</h3>
    <p id="pauseText">Muchos errores seguidos o 3 clics en â€œcomprarâ€. <br/>El Jefe dice: â€œVolvamos a calibrar el Reveladorâ€.</p>
    <div class="center">
      <button id="btnResume" class="btn big ok">ğŸ” Reintentar escenario</button>
    </div>
  </div>
</div>

<!-- Scanner lens -->
<div id="lens" class="lens" aria-hidden="true"></div>

<!-- Live region for voice text -->
<div id="aria" class="sr-only" aria-live="polite"></div>

<script>
/* 
  ===========================
   Los Caza-Anuncios: MisiÃ³n RevelaciÃ³n
  ===========================
  DiseÃ±o educativo (2Â° primaria):
  - Diferenciar INFORMAR (ğŸ“š) vs VENDER/PERSUADIR (ğŸ’°).
  - El "Revelador" muestra un AURA sobre los elementos: azul ğŸ“š o naranja ğŸ’°.
  - Al clasificar, si es error, se resaltan seÃ±ales publicitarias (urgencia, colores, "patrocinado", cÃ³digo).
  - Comentarios explican el enfoque de ciudadanÃ­a digital.
*/

/* ---------- Utilidades de audio simples (sin archivos, usando WebAudio) ---------- */
const AudioKit = (() => {
  const ctx = typeof AudioContext !== 'undefined' ? new AudioContext() :
              typeof webkitAudioContext !== 'undefined' ? new webkitAudioContext() : null;
  function beep(freq=880, dur=0.12, type='sine', gain=0.05){
    if(!ctx) return;
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = type; o.frequency.value = freq;
    g.gain.value = gain; o.connect(g); g.connect(ctx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); }, dur*1000);
  }
  return {
    ok(){beep(900,0.11,'triangle',0.06)},
    info(){beep(650,0.11,'sine',0.05)},
    warn(){beep(200,0.18,'square',0.07)},
    bonus(){beep(600,0.09,'sawtooth',0.06); setTimeout(()=>beep(900,0.09,'sawtooth',0.06),100)}
  };
})();

/* ---------- Voz opcional ---------- */
let voiceOn = false;
const voiceToggle = document.getElementById('voiceToggle');
voiceToggle.addEventListener('change', ()=> voiceOn = voiceToggle.checked);
function speak(text){
  document.getElementById('aria').textContent = text;
  if(!voiceOn || !('speechSynthesis' in window)) return;
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'es-MX';
  u.rate = 1; u.pitch = 1;
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(u);
}

/* ---------- Estado global ---------- */
const State = {
  current:'BRIEFING',
  scenarioIndex:0,
  score:0,
  streak:0,
  lives:3,
  consErrors:0,
  buyClicks:0,
  analyzedSet:new Set(), // ids escaneados al menos una vez
  revealedAds:new Set(), // ids clasificados correctamente como ğŸ’°
  errorSignals:new Set(), // seÃ±ales aprendidas en errores
  pedia:new Set(), // tipos de espectros descubiertos
  totalTargets:0,
  classifiedThisScenario:0,
  timeAttack:false,
};
const Chips = {
  state: document.getElementById('stateChip'),
  score: document.getElementById('scoreChip'),
  prog: document.getElementById('progChip'),
  lives: document.getElementById('livesChip'),
};
function updateHUD(){
  Chips.state.textContent = State.current;
  Chips.score.textContent = `Puntaje: ${State.score}`;
  Chips.prog.textContent  = `Progreso: ${State.classifiedThisScenario}/${State.totalTargets}`;
  const hearts = 'â¤ï¸'.repeat(State.lives) + 'ğŸ–¤'.repeat(Math.max(0,3-State.lives));
  Chips.lives.innerHTML = `Vidas: <span>${hearts}</span>`;
}

/* ---------- Estructura de datos de escenarios ---------- */
const scenarios = [
  {
    id:'esc1',
    title:'Escenario 1 â€” La PÃ¡gina de Videos',
    type:'videos',
    pediaType:'video-anuncio',
    targets:[
      {
        id:'videoA', title:'CÃ³mo hacer un volcÃ¡n de bicarbonato', copy:'Experimento paso a paso.',
        initialIntent:'info', revealedIntent:'info', tricks:[], kind:'video'
      },
      {
        id:'videoB', title:'Â¡Nueva MuÃ±eca que Habla!', copy:'CanciÃ³n pegajosa, colores intensos. Â¡OFERTA!',
        initialIntent:'sell', revealedIntent:'sell', tricks:['Colores brillantes','Urgencia "Â¡OFERTA!"'], kind:'video'
      },
      {
        id:'videoC', title:'Tu YouTuber favorito jugando', copy:'Gameplay divertido',
        initialIntent:'info', revealedIntent:'info', tricks:['CÃ³digo de descuento "JUEGACOOL"','IntegraciÃ³n comercial'], kind:'video', flipAfter:3000, flipTo:'sell'
      },
    ]
  },
  {
    id:'esc2',
    title:'Escenario 2 â€” El Juego Gratuito',
    type:'runner',
    pediaType:'pop-up',
    targets:[
      {
        id:'flashPopup', title:'Â¡OFERTA FLASH!', copy:'Compra auto dorado por 100 gemas. Â¡Solo 1 minuto!',
        initialIntent:'sell', revealedIntent:'sell', tricks:['"OFERTA FLASH"','Temporizador','BotÃ³n COMPRAR'], kind:'popup'
      }
    ]
  },
  {
    id:'esc3',
    title:'Escenario 3 â€” La Red Social',
    type:'social',
    pediaType:'publicaciÃ³n patrocinada',
    targets:[
      {
        id:'sponPost', title:'Galletas perfectas', copy:'Â¡Las mejores galletas del universo!',
        initialIntent:'sell', revealedIntent:'sell', tricks:['Etiqueta "patrocinado"','Logo visible'], kind:'sponsored'
      }
    ]
  }
];

/* ---------- MÃ¡quina de estados ---------- */
const elBriefing = document.getElementById('briefingScreen');
const elCity     = document.getElementById('cityScreen');
const elReport   = document.getElementById('reportScreen');
const playArea   = document.getElementById('playArea');

function showScreen(name){
  for(const s of [elBriefing, elCity, elReport]) s.classList.remove('active');
  if(name==='BRIEFING'){ elBriefing.classList.add('active'); }
  if(name==='CITY'){ elCity.classList.add('active'); }
  if(name==='REPORT'){ elReport.classList.add('active'); }
  State.current = name;
  updateHUD();
}

document.getElementById('startBtn').addEventListener('click', ()=>{
  startBriefing();
});

function startBriefing(){
  speak('Bienvenido, Caza Anuncios. Recibe el Revelador de Intenciones.');
  showScreen('CITY');
  State.scenarioIndex = 0;
  startScenario(scenarios[0].id);
}

/* ---------- Escenarios ---------- */
function startScenario(id){
  const sc = scenarios.find(s=>s.id===id);
  if(!sc) return;
  State.classifiedThisScenario = 0;
  State.totalTargets = sc.targets.length;
  State.consErrors = 0;
  State.buyClicks = 0;
  updateHUD();
  playArea.innerHTML = '';
  const h = document.createElement('h3'); h.textContent = 'ğŸ¬ ' + sc.title;
  playArea.appendChild(h);

  if(sc.type==='videos'){ renderScenario1(sc); }
  if(sc.type==='runner'){ renderScenario2(sc); }
  if(sc.type==='social'){ renderScenario3(sc); }

  // Reset classify buttons
  setCurrentTarget(null);
  disableClassify(true);
}

function renderScenario1(sc){
  const grid = document.createElement('div'); grid.className='targets video-grid';
  sc.targets.forEach(t=>{
    const card = document.createElement('div');
    card.className = 'card video-card';
    card.dataset.targetId = t.id;
    card.tabIndex = 0;
    // Visual flavor
    if(t.id==='videoB') card.innerHTML += `<div class="color-burst" aria-hidden="true"></div>`;
    const halo = document.createElement('div'); halo.className='halo'; card.appendChild(halo);
    const stamp = document.createElement('div'); stamp.className='stamp'; card.appendChild(stamp);
    const explain = document.createElement('div'); explain.className='explain'; card.appendChild(explain);

    const tag = document.createElement('div'); tag.className='tag'; tag.textContent='ğŸï¸ Video'; card.appendChild(tag);

    const h3=document.createElement('h3'); h3.textContent = t.title + (t.id==='videoB'?' â€” 15s':''); card.appendChild(h3);
    const p=document.createElement('p'); p.textContent = t.copy; card.appendChild(p);

    // Special for videoC: hidden code appears after reveal flip
    if(t.id==='videoC'){
      const code = document.createElement('div');
      code.style.position='absolute'; code.style.bottom='10px'; code.style.left='10px';
      code.style.fontWeight='900'; code.style.display='none';
      code.textContent='Usen mi cÃ³digo JUEGACOOL para comprarlo';
      code.className='code-msg';
      card.appendChild(code);
    }

    grid.appendChild(card);
  });
  playArea.appendChild(grid);
}

function renderScenario2(sc){
  const track = document.createElement('div'); track.className='card'; track.style.minHeight='240px';
  track.innerHTML = `<h3>ğŸï¸ Carrera en marcha...</h3><p>Â¡Sigue hasta que aparezca algo sospechoso!</p>`;
  playArea.appendChild(track);

  // Popup
  const pop = document.createElement('div');
  pop.className='popup'; pop.dataset.targetId = 'flashPopup';
  pop.innerHTML = `
    <h3 style="color:var(--gold); font-size:26px">âš¡ Â¡OFERTA FLASH!</h3>
    <p>Compra auto dorado por <b>100 gemas</b>. <span class="timer">00:59</span> restantes.</p>
    <div class="row">
      <button class="buy-btn" id="fakeBuyBtn">COMPRAR</button>
      <button class="btn" id="fakeCloseBtn">Cerrar</button>
    </div>
    <div class="halo"></div>
    <div class="stamp"></div>
    <div class="explain"></div>
  `;
  playArea.appendChild(pop);

  // Timer + show popup after short delay
  setTimeout(()=>{ pop.classList.add('on'); startPopupTimer(pop.querySelector('.timer')); speak('Â¡AtenciÃ³n! ApareciÃ³ una oferta flash. EscanÃ©ala con el Revelador.'); }, 1200);

  document.getElementById('fakeBuyBtn').addEventListener('click', ()=>{
    State.buyClicks++;
    if(State.buyClicks>=3){ triggerPause('Hiciste 3 clics en COMPRAR. Â¡Cuidado con las compras impulsivas!'); }
  });
  document.getElementById('fakeCloseBtn').addEventListener('click', ()=>{
    // Solo se cierra si clasifica correctamente ğŸ’°
    speak('Primero clasifica para cerrar.');
  });
}

function renderScenario3(sc){
  const feed = document.createElement('div'); feed.className='feed';
  // Amigos (informativos/entretenimiento)
  ['Foto de mi gato','Paseo en bici','Mi dibujo nuevo'].forEach((t,i)=>{
    const post = document.createElement('div'); post.className='card post';
    post.innerHTML = `<h3>ğŸ‘« Amig@ ${i+1}</h3><p>${t}</p>`;
    feed.appendChild(post);
  });

  // Sponsored post
  const s = sc.targets[0];
  const sponsored = document.createElement('div');
  sponsored.className='card post img-cookie';
  sponsored.dataset.targetId=s.id;
  sponsored.innerHTML = `
    <div class="spon-tag">patrocinado</div>
    <div class="logo-box">GALLETIXâ„¢</div>
    <h3>ğŸª ${s.title}</h3>
    <p>${s.copy}</p>
    <div class="halo"></div>
    <div class="stamp"></div>
    <div class="explain"></div>
  `;
  feed.appendChild(sponsored);

  playArea.appendChild(feed);
}

/* Popup timer (scenario 2) */
function startPopupTimer(el){
  let n=59; el.textContent='00:59';
  const id=setInterval(()=>{
    n--; if(n<0){ clearInterval(id); return; }
    const s = n.toString().padStart(2,'0');
    el.textContent=`00:${s}`;
  },1000);
}

/* ---------- Revelado y clasificaciÃ³n ---------- */
let currentTargetId = null;
function setCurrentTarget(id){
  currentTargetId = id;
  disableClassify(!id);
}

function disableClassify(dis=true){
  document.getElementById('btnInfo').disabled = dis;
  document.getElementById('btnSell').disabled = dis;
}

function targetById(id){
  const sc = scenarios[State.scenarioIndex];
  if(State.timeAttack && TA.deck){ return TA.deck.find(t=>t.id===id); }
  return sc.targets.find(t=>t.id===id);
}

/* Activa el escÃ¡ner al mantener pulsado o con botÃ³n/espacio */
const lens = document.getElementById('lens');
let scanning = false;
let cursor = {x:window.innerWidth/2, y:window.innerHeight/2};
let rafId = null;

function activateScanner(){
  scanning = true;
  lens.classList.add('scanning');
  AudioKit.info();
}
function deactivateScanner(){
  scanning = false;
  lens.classList.remove('scanning');
}

function revealIntent(targetId){
  const t = targetById(targetId);
  if(!t) return;
  State.analyzedSet.add(t.id);

  // Logica especial: videoC que cambia de intenciÃ³n tras 3s
  if(t.id==='videoC' && t.flipAfter && t.revealedIntent!=='sell'){
    const card = findCardById(t.id);
    const codeMsg = card?.querySelector('.code-msg');
    setTimeout(()=>{
      t.revealedIntent = t.flipTo; // cambia a vender
      if(codeMsg){ codeMsg.style.display='block'; }
      // Feedback visual inmediato si sigue revelando
      if(card){ applyHalo(card, t.revealedIntent); }
      speak('AtenciÃ³n: ahora hay cÃ³digo JUEGACOOL. CambiÃ³ a vender.');
    }, t.flipAfter);
  }

  // Visual: halo + icono
  const card = findCardById(t.id);
  if(card){ applyHalo(card, t.revealedIntent || t.initialIntent); }

  setCurrentTarget(t.id);
}

function applyHalo(card, intent){
  const halo = card.querySelector('.halo');
  halo.className = 'halo ' + (intent==='sell'?'sell':'info');
  halo.style.display='block';
}

function classify(choice){
  if(!currentTargetId) return;
  const t = targetById(currentTargetId);
  const right = (t.revealedIntent || t.initialIntent) === (choice==='info'?'info':'sell');
  const card = findCardById(t.id);
  const stamp = card?.querySelector('.stamp');
  const explain = card?.querySelector('.explain');

  // sello + feedback
  if(stamp){
    stamp.className='stamp on ' + (right?'ok':'warn');
    stamp.textContent = right ? (choice==='info' ? 'ğŸ“š Contenido para aprender' : 'ğŸ’° Â¡Anuncio identificado!') 
                              : 'âŒ Revisa las seÃ±ales';
  }

  if(right){
    // score, streak, bonus
    State.score += 1;
    State.streak += 1;
    State.consErrors = 0;
    if(choice==='sell'){ State.revealedAds.add(t.id); }
    if(State.streak>0 && State.streak%3===0){ State.score += 1; flashBonus(); }
    AudioKit.ok();
    speak(choice==='sell' ? 'Â¡Anuncio identificado!' : 'Â¡Correcto! Es para aprender.');
  }else{
    State.score -= 1;
    State.streak = 0;
    State.consErrors += 1;
    State.lives = Math.max(0, State.lives - 1);
    AudioKit.warn();
    // mostrar explicaciÃ³n de trucos
    if(explain){
      explain.classList.add('on');
      explain.innerHTML = `
        <p><b>Â¿Por quÃ© es publicidad?</b></p>
        <ul>${t.tricks.map(s=>`<li>ğŸ” ${highlightSignal(s)}</li>`).join('')}</ul>
        <p><i>â€œÂ¡Con colores y prisa me quieren llevar, pero yo decido en quÃ© confiar!â€</i></p>
      `;
      // Registrar seÃ±ales aprendidas en error
      t.tricks.forEach(s=> State.errorSignals.add(signalKey(s)));
    }
    speak('Error. Observa las seÃ±ales publicitarias.');
    if(State.consErrors>=3 || State.lives===0){ triggerPause('Demasiados errores. Respiremos y volvamos a intentar.'); return; }
  }

  // marcar como clasificado (evitar doble conteo)
  if(!t._done){
    t._done = true;
    State.classifiedThisScenario++;
  }
  updateHUD();

  // completar escenario si procede
  checkScenarioClear();
}

function highlightSignal(text){
  // resalta palabras clave
  return text
    .replace(/OFERTA|FLASH|COMPRA|COMPRA YA|URG(ENCIA)?/gi,'<b>$&</b>')
    .replace(/patrocinado/gi,'<b>patrocinado</b>')
    .replace(/cÃ³digo|descuento|JUEGACOOL/gi,'<b>$&</b>');
}

function signalKey(s){ return s.toLowerCase().replace(/\s+/g,' ').trim(); }

function flashBonus(){
  const b = document.createElement('div');
  b.className='badge'; b.style.position='fixed'; b.style.top='64px'; b.style.left='50%';
  b.style.transform='translateX(-50%)'; b.style.zIndex='80';
  b.style.borderColor='#3ad'; b.style.background='#09222b';
  b.textContent='ğŸ”¥ Â¡Mini-BONUS por racha!';
  document.body.appendChild(b); AudioKit.bonus();
  setTimeout(()=>{ b.remove(); }, 1200);
}

/* ---------- Avance de escenario / reporte ---------- */
function checkScenarioClear(){
  if(State.classifiedThisScenario >= State.totalTargets){
    // AÃ±adir a pedia el tipo de espectro del escenario si al menos un ğŸ’° correcto
    const sc = scenarios[State.scenarioIndex];
    if([...State.revealedAds].some(id=> (sc.targets.map(t=>t.id)).includes(id))){
      State.pedia.add(sc.pediaType);
    }
    setTimeout(()=>{
      // Siguiente
      if(State.timeAttack){
        TA.nextRound();
        return;
      }
      if(State.scenarioIndex < scenarios.length - 1){
        State.scenarioIndex++;
        startScenario(scenarios[State.scenarioIndex].id);
      }else{
        showReport();
      }
    }, 400);
  }
}

function showReport(){
  showScreen('REPORT');
  const analyzed = State.analyzedSet.size;
  const revealed = State.revealedAds.size;
  const errors = Math.max(0, (analyzed - (revealed + countInfoCorrect())));
  const learned = [...State.errorSignals].map(s=>`<span class="badge">${s}</span>`).join(' ') || '<i>â€”</i>';

  const sum = document.getElementById('reportSummary');
  sum.innerHTML = `
    <h3>Resumen</h3>
    <p><span class="badge">Analizaste: ${analyzed}</span>
       <span class="badge">Revelaste Espectros ğŸ’°: ${revealed}</span>
       <span class="badge">Errores estimados: ${errors}</span>
       <span class="badge">Puntaje final: ${State.score}</span>
    </p>
    <p>SeÃ±ales aprendidas: ${learned}</p>
    <p class="badge" style="border-color:#6c6; background:#0f2415">âœ… Â¡MisiÃ³n cumplida! Tu ojo crÃ­tico es de Ã©lite.</p>
  `;

  const p = document.getElementById('pedia');
  p.innerHTML = '';
  [
    {k:'video-anuncio',desc:'Tarjeta de video con intenciÃ³n de vender.'},
    {k:'pop-up',desc:'Ventana emergente que interrumpe para vender.'},
    {k:'publicaciÃ³n patrocinada',desc:'Post con etiqueta "patrocinado" o logo.'},
  ].forEach(item=>{
    const c=document.createElement('div'); c.className='card';
    c.innerHTML = `<h4>${item.k}</h4><p>${item.desc}</p><div style="position:absolute;right:10px;bottom:8px;font-weight:900">${State.pedia.has(item.k)?'ğŸ”“ Descubierto':'ğŸ”’ Por descubrir'}</div>`;
    p.appendChild(c);
  });
}

function countInfoCorrect(){
  // Cuenta cuÃ¡ntos ğŸ“š correctos se clasificaron (aprox. = analizados info correctos)
  let n=0;
  for(const sc of scenarios){
    for(const t of sc.targets){
      if(t._done && (t.revealedIntent||t.initialIntent)==='info') n++;
    }
  }
  if(State.timeAttack && TA.resultsInfo) n += TA.resultsInfo;
  return n;
}

function resetGame(){
  // Limpia banderas de cada target
  scenarios.forEach(sc=> sc.targets.forEach(t=>{
    t._done=false; t.revealedIntent = t.initialIntent;
  }));
  State.current='BRIEFING';
  State.scenarioIndex=0; State.score=0; State.streak=0; State.lives=3; State.consErrors=0;
  State.buyClicks=0; State.analyzedSet.clear(); State.revealedAds.clear(); State.errorSignals.clear();
  State.pedia.clear(); State.totalTargets=0; State.classifiedThisScenario=0; State.timeAttack=false;
  updateHUD();
  showScreen('BRIEFING');
}

/* ---------- Pausa / Reintento ---------- */
function triggerPause(msg){
  const overlay = document.getElementById('pauseOverlay');
  document.getElementById('pauseText').innerHTML = msg;
  overlay.classList.add('on');
  speak('Pausa de aprendizaje. Intentemos de nuevo.');
}
document.getElementById('btnResume').addEventListener('click', ()=>{
  document.getElementById('pauseOverlay').classList.remove('on');
  // Reiniciar escenario actual
  State.lives=3; State.consErrors=0; State.buyClicks=0; State.streak=0;
  const sc = scenarios[State.scenarioIndex];
  sc.targets.forEach(t=>{ t._done=false; t.revealedIntent=t.initialIntent; });
  startScenario(sc.id);
});
document.getElementById('btnRetry').addEventListener('click', ()=>{
  State.lives=3; State.consErrors=0; State.buyClicks=0; State.streak=0;
  const sc = scenarios[State.scenarioIndex];
  sc.targets.forEach(t=>{ t._done=false; t.revealedIntent=t.initialIntent; });
  startScenario(sc.id);
});

/* ---------- UI helpers ---------- */
function findCardById(id){
  return playArea.querySelector(`[data-target-id="${CSS.escape(id)}"]`);
}

/* ---------- Controles: mouse / tacto / teclado ---------- */
function onMove(x,y){
  cursor.x=x; cursor.y=y;
  lens.style.left = (x-55)+'px';
  lens.style.top  = (y-55)+'px';
}
window.addEventListener('mousemove', e=>onMove(e.clientX,e.clientY), {passive:true});
window.addEventListener('touchstart', e=>{
  const t=e.changedTouches[0]; onMove(t.clientX,t.clientY);
  activateScanner();
}, {passive:true});
window.addEventListener('touchmove', e=>{
  const t=e.changedTouches[0]; onMove(t.clientX,t.clientY);
}, {passive:true});
window.addEventListener('touchend', ()=> deactivateScanner(), {passive:true});

window.addEventListener('mousedown', (e)=>{
  if(e.button===0){ activateScanner(); }
});
window.addEventListener('mouseup', (e)=>{
  if(e.button===0){ deactivateScanner(); }
});

// BotÃ³n Activar Revelador
document.getElementById('btnReveal').addEventListener('mousedown', activateScanner);
document.getElementById('btnReveal').addEventListener('mouseup', deactivateScanner);
document.getElementById('btnReveal').addEventListener('touchstart', (e)=>{e.preventDefault(); activateScanner();}, {passive:false});
document.getElementById('btnReveal').addEventListener('touchend', (e)=>{e.preventDefault(); deactivateScanner();}, {passive:false});

// Teclado
window.addEventListener('keydown', (e)=>{
  if(e.code==='Space'){ e.preventDefault(); activateScanner(); }
  if(e.key==='1'){ classify('info'); }
  if(e.key==='2'){ classify('sell'); }
  if(e.key==='r' || e.key==='R'){ document.getElementById('btnRetry').click(); }
});
window.addEventListener('keyup', (e)=>{ if(e.code==='Space'){ deactivateScanner(); } });

// Botones de clasificar
document.getElementById('btnInfo').addEventListener('click', ()=> classify('info'));
document.getElementById('btnSell').addEventListener('click', ()=> classify('sell'));

/* ---------- Bucle de escaneo con rAF (detectar objetivos bajo la lente) ---------- */
function scanLoop(){
  if(scanning){
    const cx = cursor.x, cy = cursor.y;
    // buscamos el elemento con data-target-id mÃ¡s cercano al centro de la lente
    const els = document.elementsFromPoint(cx, cy);
    const targetEl = els.find(el=> el instanceof Element && el.dataset && el.dataset.targetId);
    if(targetEl){
      const id = targetEl.dataset.targetId;
      revealIntent(id);
    }
  }
  rafId = requestAnimationFrame(scanLoop);
}
rafId = requestAnimationFrame(scanLoop);

/* ---------- Inicio / Siguiente / Reporte Buttons ---------- */
document.getElementById('btnReset').addEventListener('click', resetGame);

/* ---------- Modo Contrarreloj (opcional) ---------- */
const TA = {
  deck:null, idx:0, left:20, time:60, timerId:null, resultsInfo:0, resultsSell:0,
  start(){
    State.timeAttack=true; this.deck = this.makeDeck(20); this.idx=0; this.left=20; this.time=60; this.resultsInfo=0; this.resultsSell=0;
    State.lives=3; State.consErrors=0; State.classifiedThisScenario=0; State.totalTargets=1;
    showScreen('CITY'); startScenario(this.deck[0].__scid);
    this.tick();
  },
  makeDeck(n){
    const arr=[];
    for(let i=0;i<n;i++){
      const isSell = Math.random()<0.5;
      arr.push({
        id:'TA_'+i, title:isSell?'Â¡SUPER OFERTA!' : 'Dato curioso',
        copy:isSell?'-20% solo hoy' : 'Â¿SabÃ­as queâ€¦?',
        initialIntent:isSell?'sell':'info', revealedIntent:isSell?'sell':'info',
        tricks:isSell?['Urgencia','Colores brillantes','BotÃ³n comprar']:[],
        kind:isSell?'rand-sell':'rand-info',
        __scid:'ta_'+i
      });
    }
    return arr;
  },
  buildCard(t){
    const card = document.createElement('div'); card.className='card'; card.dataset.targetId=t.id;
    card.innerHTML = `<h3>${t.initialIntent==='sell'?'ğŸ’°':'ğŸ“š'} ${t.title}</h3><p>${t.copy}</p><div class="halo"></div><div class="stamp"></div><div class="explain"></div>`;
    return card;
  },
  tick(){
    clearInterval(this.timerId);
    const chip = document.getElementById('stateChip');
    chip.textContent = `CONTRARRELOJ â±ï¸ ${this.time}s`;
    this.timerId = setInterval(()=>{
      this.time--; chip.textContent = `CONTRARRELOJ â±ï¸ ${this.time}s`;
      if(this.time<=0){
        clearInterval(this.timerId);
        showReport();
      }
    },1000);
  },
  nextRound(){
    this.idx++;
    this.left--;
    if(this.left<=0){ showReport(); return; }
    State.classifiedThisScenario=0; State.totalTargets=1;
    startScenario(this.deck[this.idx].__scid);
  }
};

document.getElementById('btnTimeAttack').addEventListener('click', ()=> TA.start());

/* ---------- Render de escenario para Contrarreloj ---------- */
function startScenarioTa(scid){
  // no usado (integramos en startScenario), pero dejamos hook
}

/* ---------- Hook: startScenario para TA ---------- */
const _origStartScenario = startScenario;
startScenario = function(id){
  if(State.timeAttack && id && id.startsWith('ta_')){
    playArea.innerHTML='';
    const t = TA.deck[TA.idx];
    const h = document.createElement('h3'); h.textContent = `â±ï¸ Contrarreloj â€” ${TA.left} restantes`;
    playArea.appendChild(h);
    const holder = document.createElement('div'); holder.className='targets';
    holder.appendChild(TA.buildCard(t));
    playArea.appendChild(holder);
    setCurrentTarget(null); disableClassify(true);
    State.classifiedThisScenario=0; State.totalTargets=1; updateHUD();
    return;
  }
  _origStartScenario(id);
}

/* ---------- BotÃ³n Reiniciar campaÃ±a desde reporte ---------- */
document.getElementById('btnReset').addEventListener('click', resetGame);

/* =================== DiferenciaciÃ³n informar vs vender (nota pedagÃ³gica) ===================
   - 'informar' (ğŸ“š): contenido cuyo objetivo es enseÃ±ar o explicar sin empujar a una compra.
     En el juego: halo azul, sello â€œContenido para aprenderâ€, voz â€œÂ¡Correcto! Es para aprender.â€
   - 'vender/persuadir' (ğŸ’°): busca que compres o uses algo; usa seÃ±ales como urgencia, colores vivos,
     cÃ³digos y etiqueta â€œpatrocinadoâ€.
     En el juego: halo naranja, sello â€œÂ¡Anuncio identificado!â€, y si hay error se muestran las seÃ±ales.
   ================================================================================================= */

/* ---------- Iniciar HUD ---------- */
updateHUD();

/* ---------- START button: already wired ---------- */

</script>
</body>
</html>
